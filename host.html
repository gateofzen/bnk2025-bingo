<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BNK2025 - HOST FINAL</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <style>
    @font-face {
      font-family: 'BrotherXL';
      src: url('./fonts/Brother_XL_Regular.otf') format('opentype');
      font-weight: normal;
      font-style: normal;
    }

    body {
      font-family: 'BrotherXL', Arial, sans-serif;
      margin: 0; padding: 0;
      background-color: black;
      background-image: url('./FC_logo.png');
      background-repeat: no-repeat;
      background-position: center center;
      background-attachment: fixed;
      background-size: cover;
      display: flex; justify-content: center; align-items: center;
      flex-direction: column; height: 100vh; color: white;
      position: relative; overflow: hidden;
    }

    .version-tag { position: absolute; top: 5px; right: 5px; font-size: 0.7rem; color: #aaa; z-index: 2000; font-family: sans-serif; }

    .container {
      text-align: center; width: 100%;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
    }

    #result {
      font-size: 9rem; font-weight: bold; margin-bottom: 10px;
      display: inline-block; cursor: pointer;
      text-shadow: 0 0 10px rgba(0,0,0,0.5);
      min-height: 1.2em; line-height: 1.2; z-index: 10;
    }
    #result:active { transform: scale(0.98); }

    #joinQr {
      width: 220px; height: 220px; margin: 20px auto;
      border: 6px solid white; border-radius: 15px;
      display: block; box-shadow: 0 0 30px rgba(255,255,255,0.4); cursor: pointer;
      transition: transform 0.1s;
    }
    #joinQr:active { transform: scale(0.95); }

    #historyContainer {
      margin-top: 20px; margin-bottom: 20px;
      font-size: 2.1rem; text-align: center; min-height: 80px;
    }
    #historyList { list-style: none; padding: 0; margin: 0; }
    #historyList li { margin: 3px; display: inline-block; }

    #linkButton {
      position: fixed; left: 30px; bottom: 30px; width: 80px; height: 80px;
      background: transparent; border: 1px solid rgba(255, 255, 255, 0.1);
      cursor: pointer; transition: all 0.3s ease; text-decoration: none;
      z-index: 1000; display: block;
    }
    #linkButton:hover { border-color: rgba(255, 255, 255, 0.3); transform: scale(1.05); }

    #resetButton {
      position: fixed; top: 20px; right: 20px;
      background: rgba(0, 0, 0, 0.5); color: #aaa;
      border: 1px solid #555; padding: 5px 10px;
      font-size: 0.8rem; cursor: pointer; z-index: 1000;
    }
    #resetButton:hover { background: red; color: white; }

    #playerCounter {
      position: fixed; top: 20px; left: 20px;
      font-size: 1.5rem; font-weight: bold; color: rgba(255,255,255,0.8);
      text-shadow: 0 0 5px black; z-index: 1000;
      cursor: pointer; padding: 5px 10px; border-radius: 5px;
      transition: background 0.3s;
    }
    #playerCounter:hover { background: rgba(255, 255, 255, 0.2); color: white; }

    #testTrigger {
        position: fixed; bottom: 0; right: 0; width: 50px; height: 50px;
        background: transparent; z-index: 9999; cursor: pointer;
    }

    .modal-overlay {
      display: none; position: fixed; top: 0; left: 0; 
      width: 100%; height: 100%; background: rgba(0,0,0,0.95);
      z-index: 2000; flex-direction: column; 
      justify-content: center; align-items: center;
    }
    .close-modal { 
      padding: 10px 30px; font-size: 1.5rem; margin-top: 30px;
      background: transparent; border: 2px solid white; 
      color: white; cursor: pointer; border-radius: 30px;
      position: relative; z-index: 3000;
    }

    .bingo-text { font-size: 8rem; font-weight: bold; color: #FF3300; margin-bottom: 20px; animation: popIn 0.5s; }
    #winnerListContainer {
      display: flex; flex-direction: column; align-items: center;
      max-height: 60vh; overflow-y: auto; width: 100%;
    }
    .winner-name-item { 
      font-size: 5rem; color: white; margin: 10px 0;
      text-shadow: 0 0 20px #FF9933; animation: slideUp 0.5s ease-out;
    }

    .player-list-title { font-size: 3rem; font-weight: bold; color: #FF9933; margin-bottom: 30px; }
    
    #playerListContent {
      display: grid; gap: 15px;
      width: 90%; max-width: 1200px;
      max-height: 70vh; overflow-y: auto; padding: 20px;
      grid-template-columns: repeat(4, 1fr);
    }
    .grid-large { grid-template-columns: repeat(3, 1fr) !important; }
    .grid-medium { grid-template-columns: repeat(4, 1fr) !important; }
    .grid-small { grid-template-columns: repeat(5, 1fr) !important; }

    .player-tile {
      background: #222; border: 1px solid #555; border-radius: 15px;
      display: flex; justify-content: center; align-items: center;
      text-align: center; padding: 15px;
      color: #ddd; font-weight: bold;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      transition: transform 0.2s;
    }
    .player-tile:hover { transform: translateY(-2px); border-color: #888; }

    .player-tile.is-winner {
      background: linear-gradient(135deg, #332200, #664400);
      border: 2px solid #FFD700; color: #FFD700;
      box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
    }

    .font-large { font-size: 2.5rem; height: 100px; }
    .font-medium { font-size: 1.8rem; height: 80px; }
    .font-small { font-size: 1.2rem; height: 60px; }

    @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }
    @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  </style>
</head>
<body>
  <div class="version-tag">Ver 37.0 (Reset Logic Fix)</div>

  <button id="resetButton" onclick="resetGame()">RESET</button>
  <div id="playerCounter" onclick="showPlayerList()">PLAYERS: 0</div>
  
  <div id="testTrigger" onclick="runTestMode()"></div>

  <div class="container">
    <p id="result">ARE U READY?</p>
    <img id="joinQr" src="./qr-code.png" alt="Join Game" onclick="performDraw()">
    <div id="historyContainer">
      <p style="font-size:1rem; margin:0; opacity:0.7;">Past Results:</p>
      <ul id="historyList"></ul>
    </div>
  </div>

  <a href="https://gateofzen.github.io/screen/" target="_blank" id="linkButton"></a>

  <div id="winnerModal" class="modal-overlay">
    <div class="bingo-text">BINGO!!!</div>
    <div id="winnerListContainer"></div>
    <button class="close-modal" onclick="hideModal('winnerModal')">CLOSE</button>
  </div>

  <div id="playerListModal" class="modal-overlay">
    <div class="player-list-title">PARTICIPANTS</div>
    <div id="playerListContent"></div>
    <button class="close-modal" onclick="hideModal('playerListModal')">CLOSE</button>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDNPT6qv47ku9PBYLm_9FDl-hY0sQqZHn8",
      authDomain: "bnk2025-bingo.firebaseapp.com",
      databaseURL: "https://bnk2025-bingo-default-rtdb.firebaseio.com",
      projectId: "bnk2025-bingo",
      storageBucket: "bnk2025-bingo.firebasestorage.app",
      messagingSenderId: "127094139624",
      appId: "1:127094139624:web:703cf76da95ba05154b75d",
      measurementId: "G-2LVWF4GVS5"
    };

    // candidates„É™„Çπ„Éà (ÁúÅÁï•)
    const candidates = []; 

    function hideModal(id) {
      document.getElementById(id).style.display = 'none';
      if (id === 'winnerModal') {
         document.getElementById('winnerListContainer').innerHTML = '';
      }
    }

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const resultElement = document.getElementById('result');
    const qrElement = document.getElementById('joinQr');
    const historyList = document.getElementById('historyList');
    const playerCounter = document.getElementById('playerCounter');

    let availableCandidates = [ /*ÁúÅÁï•: index.html„Å®Âêå„Åò„ÇÇ„ÅÆ*/ ];
    // ‚òÖÊ≥®ÊÑè: ÂÆüÈöõ„ÅÆ„Éï„Ç°„Ç§„É´„Åß„ÅØÂøÖ„Åö„Åì„Åì„Å´candidates„ÅÆÈÖçÂàó„ÇíË≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ
    
    let history = [];
    let lastGenre = null;
    let sameGenreCount = 0;
    let isAnimating = false;
    let animationInterval = null;
    
    let playersData = []; 
    let winnersData = []; 
    
    const PARTICIPANTS_PATH = 'bingo_game_v37';
    let initialWinnerKeys = new Set();

    window.onload = function() {
      document.addEventListener('click', async () => {
        try {
          if ('wakeLock' in navigator) {
            await navigator.wakeLock.request('screen');
          }
        } catch(e) {}
      }, { once: true });

      db.ref('gameState/history').once('value').then(snapshot => {
        const savedHistory = snapshot.val();
        if(savedHistory) {
          const reversed = [...savedHistory].reverse();
          reversed.forEach(item => {
            const idx = availableCandidates.indexOf(item);
            if(idx > -1) availableCandidates.splice(idx, 1);
            updateGenreLogic(item);
            addToHistoryUI(item);
          });

          if(savedHistory.length > 0) {
            const latest = savedHistory[0];
            resultElement.textContent = latest;
            applyStyle(resultElement, latest);
            qrElement.style.display = 'none';
          } else {
            qrElement.style.display = 'block';
          }
        }
      });

      db.ref(PARTICIPANTS_PATH).on('value', snap => {
        playersData = [];
        snap.forEach(child => {
            const val = child.val();
            if(val) playersData.push(val);
        });
        updateCounter();
      });

      db.ref('winners').on('value', snap => {
        winnersData = [];
        snap.forEach(child => {
            const val = child.val();
            if(val) winnersData.push(val);
        });
        updateCounter();
      });

      db.ref('winners').once('value', snap => {
          snap.forEach(child => {
              initialWinnerKeys.add(child.key);
          });
          
          db.ref('winners').on('child_added', (snapshot) => {
             if (!initialWinnerKeys.has(snapshot.key)) {
                 addWinnerPopup(snapshot.val().name);
                 initialWinnerKeys.add(snapshot.key);
             }
          });
      });
    };

    // „ÉÜ„Çπ„Éà„É¢„Éº„Éâ
    function runTestMode() {
        if(!confirm("„ÉÜ„Çπ„Éà„É¢„Éº„Éâ„ÇíÈñãÂßã„Åó„Åæ„Åô„ÅãÔºü")) return;
        let count = 0;
        const testInterval = setInterval(() => {
            if(count >= 50 || availableCandidates.length === 0) {
                clearInterval(testInterval);
                return;
            }
            const finalResult = drawRandomCandidate();
            resultElement.textContent = finalResult;
            applyStyle(resultElement, finalResult);
            addToHistoryUI(finalResult);
            updateFirebase(finalResult);
            qrElement.style.display = 'none';
            count++;
        }, 200);
    }

    function updateCounter() {
      const uniquePlayers = new Set(playersData.map(p => p.name));
      const uniqueWinners = new Set(winnersData.map(w => w.name));
      let count = 0;
      uniquePlayers.forEach(p => { if (!uniqueWinners.has(p)) count++; });
      playerCounter.textContent = `PLAYERS: ${count}`;
    }

    function showPlayerList() {
      const listContainer = document.getElementById('playerListContent');
      listContainer.innerHTML = "";
      listContainer.className = "";
      const uniquePlayers = new Set(playersData.map(p => p.name));
      const total = uniquePlayers.size;
      if(total <= 15) listContainer.classList.add('grid-large'); 
      else if(total <= 30) listContainer.classList.add('grid-medium'); 
      else listContainer.classList.add('grid-small'); 
      const fontClass = total <= 15 ? 'font-large' : (total <= 30 ? 'font-medium' : 'font-small');

      if(total === 0) {
        listContainer.innerHTML = "<div style='color:#999; grid-column: 1 / -1;'>ÂèÇÂä†ËÄÖ„ÅØ„Åæ„Å†„ÅÑ„Åæ„Åõ„Çì</div>";
      } else {
        const winnerRankMap = {};
        winnersData.forEach((w, index) => { winnerRankMap[w.name] = index + 1; });
        let displayList = [];
        const addedWinners = new Set();
        winnersData.forEach((w) => {
           if(!addedWinners.has(w.name)) {
               addedWinners.add(w.name);
               displayList.push({ name: w.name, rank: addedWinners.size, isWinner: true });
           }
        });
        uniquePlayers.forEach(name => {
           if(!winnerRankMap[name]) displayList.push({ name: name, rank: null, isWinner: false });
        });
        displayList.forEach(item => {
          const div = document.createElement('div');
          div.className = `player-tile ${fontClass}`;
          if(item.isWinner) {
             div.classList.add('is-winner');
             div.innerHTML = `<span>üëë No.${item.rank}<br>${item.name}</span>`;
          } else {
             div.textContent = item.name;
          }
          listContainer.appendChild(div);
        });
      }
      document.getElementById('playerListModal').style.display = 'flex';
    }

    // ‚òÖ‰øÆÊ≠£: „É™„Çª„ÉÉ„ÉàÊôÇ„ÅØÂèÇÂä†ËÄÖ„É™„Çπ„Éà„ÇíÊÆã„Åô
    function resetGame() {
      if(!confirm("„Ç≤„Éº„É†„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü\nÔºàÂèÇÂä†ËÄÖ„É™„Çπ„Éà„Å®„Ç´„Éº„Éâ„ÅØÁ∂≠ÊåÅ„Åï„Çå„Åæ„ÅôÔºâ")) return;
      db.ref('gameState').remove();
      db.ref('winners').remove();
      // db.ref(PARTICIPANTS_PATH).remove(); // ÂâäÈô§„Åó„Å™„ÅÑ
      qrElement.style.display = 'block';
      location.reload();
    }

    function addWinnerPopup(name) {
      const container = document.getElementById('winnerListContainer');
      const modal = document.getElementById('winnerModal');
      const div = document.createElement('div');
      div.className = 'winner-name-item';
      div.textContent = name;
      container.appendChild(div);
      modal.style.display = 'flex';
    }

    resultElement.addEventListener('click', performDraw);

    // getGenre, updateGenreLogic, drawRandomCandidate, performDraw, updateFirebase, addToHistoryUI, applyStyle
    // („Åì„Çå„Çâ„ÅØÂâç„Å®Âêå„Åò„Å™„ÅÆ„ÅßÁúÅÁï•„Åõ„Åö„Ç≥„Éî„Éº„Åó„Å¶‰Ωø„Å£„Å¶„Åè„Å†„Åï„ÅÑ)
    // ‚Äª„Çπ„Éö„Éº„Çπ„ÅÆÈÉΩÂêà„Åß„Åì„Åì„Å´„ÅØË®òËºâ„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„Åå„ÄÅindex.html„Å®Âêå„ÅòÂÄôË£ú„É™„Çπ„Éà„Å®„É≠„Ç∏„ÉÉ„ÇØ„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ
    // ÂâçÂõû„ÅÆ„Ç≥„Éº„Éâ„Åæ„Åü„ÅØindex.html„Åã„ÇâÈñ¢Êï∞Áæ§„Çí„Ç≥„Éî„Éº„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
    
    function getGenre(text) {
      if (text.startsWith("FEEL")) return "FEEL";
      if (text.startsWith("L 24") || text.startsWith("L 25")) return "LIMITED";
      if (text.startsWith("BSW")) return "BSW";
      if (text.startsWith("BSB")) return "BSB";
      if (text.startsWith("BSL")) return "BSL";
      if (text.startsWith("BB3")) return "BB3";
      if (text.startsWith("BB2")) return "BB2";
      if (text.startsWith("BB1")) return "BB1";
      if (text.includes("SP") || text.startsWith("ITS") || text === "ZEDD MIX" || text === "BEERCYCLE" || text === "SKRILLEX") return "SP";
      return "OTHER";
    }

    function updateGenreLogic(selectedCandidate) {
      const currentGenre = getGenre(selectedCandidate);
      if (currentGenre === lastGenre) sameGenreCount++; else sameGenreCount = 1;
      lastGenre = currentGenre;
    }

    function drawRandomCandidate() {
      let selectedCandidate;
      let selectedIndex;
      if (lastGenre !== null) {
        let needDifferentGenre = false;
        if (lastGenre === "BB2" && sameGenreCount >= 2) needDifferentGenre = true;
        else if (lastGenre !== "BB2" && sameGenreCount >= 1) needDifferentGenre = true;
        
        if (needDifferentGenre) {
          const diff = availableCandidates.filter(c => getGenre(c) !== lastGenre);
          if (diff.length > 0) {
            selectedCandidate = diff[Math.floor(Math.random() * diff.length)];
            selectedIndex = availableCandidates.indexOf(selectedCandidate);
          }
        }
      }
      if (!selectedCandidate) {
        selectedIndex = Math.floor(Math.random() * availableCandidates.length);
        selectedCandidate = availableCandidates[selectedIndex];
      }
      availableCandidates.splice(selectedIndex, 1);
      updateGenreLogic(selectedCandidate);
      return selectedCandidate;
    }

    function performDraw() {
      if (isAnimating) return;
      if (availableCandidates.length === 0) {
        resultElement.textContent = "ALL COMPLETED!";
        applyStyle(resultElement, "");
        qrElement.style.display = 'none';
        return;
      }
      qrElement.style.display = 'none';
      isAnimating = true;
      const finalResult = drawRandomCandidate();
      animationInterval = setInterval(() => {
        const temp = availableCandidates[Math.floor(Math.random() * availableCandidates.length)] || finalResult;
        resultElement.textContent = temp;
        applyStyle(resultElement, temp);
      }, 100);
      setTimeout(() => {
        clearInterval(animationInterval);
        resultElement.textContent = finalResult;
        applyStyle(resultElement, finalResult);
        addToHistoryUI(finalResult);
        updateFirebase(finalResult);
        isAnimating = false;
        if (availableCandidates.length === 0) setTimeout(() => alert("ÂÖ®„Å¶„ÅÆ„Éó„É≠„Ç∞„É©„É†„ÅåÁµÇ‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ"), 1000);
      }, 1300);
    }

    function updateFirebase(result) {
      db.ref('gameState/history').once('value').then(snapshot => {
        const currentHistory = snapshot.val() || [];
        const newHistory = [result, ...currentHistory];
        db.ref('gameState').set({ history: newHistory, lastUpdate: Date.now() });
      });
    }

    function addToHistoryUI(item) {
      const li = document.createElement('li');
      li.textContent = item;
      applyStyle(li, item, true);
      const list = document.getElementById('historyList');
      list.prepend(li);
      if (history.length > 5) history.pop();
      if (list.children.length > 5) list.removeChild(list.lastChild);
    }

    function applyStyle(element, text, isHistoryItem = false) {
      element.removeAttribute('style'); element.removeAttribute('class');
      let bgColor = 'transparent'; let textColor = 'white';
      if (text.startsWith("BB1")) { bgColor = '#FFFF00'; textColor = 'black'; }
      else if (text.startsWith("BB2")) { bgColor = '#FF9933'; textColor = 'black'; }
      else if (text.startsWith("BB3")) { bgColor = '#FF3300'; textColor = 'black'; }
      else if (text.startsWith("BSBi")) { bgColor = '#336699'; textColor = '#DEFF66'; }
      else if (text.startsWith("BSB")) { bgColor = '#00CCFF'; textColor = 'black'; }
      else if (text.startsWith("BSWi")) { bgColor = '#990099'; textColor = '#FFEF7F'; }
      else if (text.startsWith("BSW")) { bgColor = '#CC66FF'; textColor = 'white'; }
      else if (text.startsWith("BSL")) { bgColor = '#0000CC'; textColor = 'white'; }
      else if (text.includes("FEEL NOW G")) { bgColor = '#B08A3A'; textColor = 'white'; }
      else if (text.includes("FEEL NOW S")) { bgColor = '#666666'; textColor = 'white'; }
      else if (text.includes("FEEL NOW B")) { bgColor = '#00121C'; textColor = 'white'; }
      else if (text.includes("FEEL HIGH")) { bgColor = 'white'; textColor = 'black'; }
      else if (text.includes("FEEL DEEP")) { bgColor = 'white'; textColor = 'black'; }
      else if (text.includes("BTM")) { bgColor = '#00121C'; textColor = '#BD3EA4'; }
      else if (text.includes("FREE")) { bgColor = '#00121C'; textColor = '#D61C1C'; }
      else if (text.startsWith("FEEL NOW")) { bgColor = '#00121C'; textColor = 'white'; }
      else if (text.includes("FEEL")) { bgColor = '#00121C'; textColor = '#0761F1'; }
      else if (text.includes("SP")) { bgColor = '#00121C'; textColor = 'white'; }
      else if (text === "BEERCYCLE") { bgColor = '#7A3202'; textColor = 'white'; }
      else if (text === "SKRILLEX" || text.startsWith("ITS") || text === "ZEDD MIX") { bgColor = 'white'; textColor = 'black'; }
      
      element.style.backgroundColor = bgColor; element.style.color = textColor;
      if (!isHistoryItem) { element.style.padding = '20px 40px'; element.style.cursor = 'pointer'; }
      else { element.style.padding = '5px 15px'; element.style.display = 'inline-block'; element.style.margin = '3px'; }
    }
  </script>
</body>
</html>
