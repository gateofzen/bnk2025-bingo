<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>BNK2025 - HOST FINAL</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    /* ... (CSS„ÅØVer 55.0„Å®Âêå„Åò) ... */
    @font-face { font-family: 'BrotherXL'; src: url('./fonts/Brother_XL_Regular.otf') format('opentype'); }
    /* ... (Áï•) ... */
  </style>
</head>
<body>
  <div class="version-tag">Ver 58.0</div>
  
  <div class="admin-controls">
      <button class="admin-btn" onclick="resetGame()">GAME RESET</button>
      <button class="admin-btn btn-danger" onclick="resetAllData()">FULL WIPE</button>
  </div>

  <div id="playerCounter" onclick="showPlayerList()">PLAYERS: 0</div>
  <div id="testTrigger" onclick="runTestMode()"></div>

  <div class="container">
    <div class="result-wrapper"><p id="result">ARE U READY?</p></div>
    <img id="joinQr" src="./qr-code.png" alt="Join Game" onclick="performDraw()">
    <div id="historyContainer">
      <p style="font-size:1rem; margin:0; opacity:0.7;">Past Results:</p>
      <ul id="historyList"></ul>
    </div>
  </div>
  <a href="https://gateofzen.github.io/screen/" target="_blank" id="linkButton"></a>
  
  <div id="winnerModal" class="modal-overlay">...</div>
  <div id="playerListModal" class="modal-overlay">...</div>

  <script>
    // ... (firebaseConfig) ...

    // ‚òÖ‰øÆÊ≠£: ÁúÅÁï•„Åï„Çå„Å¶„ÅÑ„ÅüÂÄôË£ú„É™„Çπ„Éà„Çí„Åì„Åì„Å´Á¢∫ÂÆü„Å´Ë®òËø∞
    const candidates = [
      "BB1 10s 1", "BB1 10s 2", "BB1 90s 1", "BB1 BRIT 2024", "BB1 Comp 1", "BB1 Comp 2", "BB1 Comp 3", "BB1 Comp 4", "BB1 DVGT", "BB1 GRMY 65", "BB1 GRMY 67",
      "BB1 Hit 1", "BB1 Hit 2", "BB1 Hit 3", "BB1 Hit 4", "BB1 Hit 5", "BB1 Hit 6", "BB1 Hit 7", "BB1 Hit 8", "BB1 Hit 9", "BB1 Hit 10", "BB1 Hit 11",
      "BB1 Hous 1", "BB1 Hous 2", "BB1 Hous 3", "BB1 Hous 4", "BB1 Hous 5", "BB1 NOW 1", "BB1 NOW 2", "BB1 Queen", "BB1 TSFT",
      "FEEL NOW B1", "FEEL NOW B2", "FEEL NOW B3", "FEEL NOW B4", "FEEL NOW G1", "FEEL NOW G2", "FEEL NOW G3", "FEEL NOW S1", "FEEL NOW S2", "FEEL NOW S3",
      "8th SP", "9th SP 1", "9th SP 2", "10th SP",
      "BB2 10s 1", "BB2 10s 2", "BB2 10s 3", "BB2 10s 4", "BB2 1D", "BB2 2016", "BB2 2017", "BB2 2018", "BB2 2019", "BB2 3Y-1", "BB2 3Y-2",
      "BB2 90s 1", "BB2 90s 2", "BB2 ADELE", "BB2 ARGD", "BB2 Avicii", "BB2 BEYONCE", "BB2 BMLY", "BB2 BNJV", "BB2 BRIT 2023", "BB2 BRIT 2025",
      "BB2 BRJ", "BB2 BRMS", "BB2 BRMS 2", "BB2 BTLS 1", "BB2 BTLS 2", "BB2 BTLS 3", "BB2 CDPY", "BB2 CDPY 2", "BB2 CHARLI",
      "BB2 Comp 1", "BB2 Comp 2", "BB2 Comp 3", "BB2 Comp 4", "BB2 Comp 5", "BB2 Comp 6", "BB2 Comp 7", "BB2 CSBW", "BB2 CSBW 2", "BB2 CVHS",
      "BB2 Deep 1", "BB2 Deep 2", "BB2 Deep 3", "BB2 Dua Lipa", "BB2 Dua Lipa 2", "BB2 DVGT", "BB2 EDM",
      "BB2 EDSR", "BB2 EMINEM", "BB2 FLG", "BB2 FOB", "BB2 GRDY", "BB2 GRMY 66",
      "BB2 Hit 1", "BB2 Hit 2", "BB2 Hit 3", "BB2 Hit 4", "BB2 Hit 5", "BB2 Hit 6", "BB2 Hit 7", "BB2 Hit 8", "BB2 Hit 9", "BB2 Hit 10",
      "BB2 Hit 11", "BB2 Hit 12", "BB2 Hit 13", "BB2 Hit 14", "BB2 Hit 15", "BB2 Hit 16", "BB2 Hit 17", "BB2 Hit 18", "BB2 Hit 19", "BB2 Hit 20", "BB2 Hit 21", "BB2 Hit 22",
      "BB2 HH 1", "BB2 HH 2", "BB2 Hous 1", "BB2 Hous 2", "BB2 Hous 3", "BB2 Hous 4", "BB2 Hous 6", "BB2 Hous 7",
      "BB2 Jazz 1", "BB2 JONAS", "BB2 JUSTIN", "BB2 KYGO", "BB2 LDGG", "BB2 LDGG 2", "BB2 MDNA", "BB2 MRN5", "BB2 MTGX", "BB2 Metal 1", "BB2 Metal 2",
      "BB2 MJ 1", "BB2 MJ 2", "BB2 MJ 3", "BB2 MLN 1", "BB2 MLN 2", "BB2 MLN 3", "BB2 Movie 1", "BB2 Movie 2", "BB2 NE-YO", "BB2 NOW 1", "BB2 NOW 2",
      "BB2 P!NK", "BB2 PTX", "BB2 QOP", "BB2 Queen", "BB2 R&B 1", "BB2 R&B 2", "BB2 Regg 1", "BB2 Regg 2", "BB2 RHCP", "BB2 RHNA", "BB2 Rock 1", "BB2 Rock 2",
      "BB2 SIGALA", "BB2 SMST", "BB2 Soul 1", "BB2 Soul 2", "BB2 SUMR 1", "BB2 SUMR 2", "BB2 UPGD 1", "BB2 UPGD 2", "BB2 UPGD 3", "BB2 USHER", "BB2 USHER 2",
      "BB2 Xmas 2", "BB2 Xmas 3", "BB2 Xmas 4", "BB2 ZEDD", "SKRILLEX", "BEERCYCLE", "FEEL DEEP", "FEEL HIGH",
      "L 25 BTM", "L 25 FEEL", "L 25 FREE",
      "BB3 10s 1", "BB3 Comp 1", "BB3 Deep 1", "BB3 HH 1", "BB3 HH 2", "BB3 Hit 1", "BB3 Hit 2", "BB3 Hit 3", "BB3 Hit 4", "BB3 Hit 5", "BB3 Hit 6",
      "BB3 Hous 1", "BB3 Hous 2", "BB3 Hous 3", "BB3 Hous 4", "BB3 IRMD", "BB3 Regg 1", "BB3 Rock 1", "BB3 Rock 2", "BB3 Soul 1", "BB3 UPGD 1", "BB3 World 1",
      "BSB 10s 1", "BSB Comp 1", "BSB Deep 1", "BSB HH 2", "BSB Hit 1", "BSB Hit 2", "BSB Hit 3", "BSB Hit 4", "BSB Hit 5", "BSB Hit 6", "BSB Hit 7",
      "BSB Hous 1", "BSB Jazz 1", "BSB Regg 1", "BSB Rock 1", "BSBi BMLY", "BSBi Deep 1", "BSBi Hous 1", "BSBi Hous 2",
      "L 24 FEEL", "L 24 FEEL 2", "L 24 FREE", "L 24 FREE 2",
      "BSL Comp 1", "BSL Deep 1", "BSL Deep 2", "BSL Deep 3", "BSL Deep 4", "BSL Hit 1", "BSL Hit 2", "BSL Hit 3", "BSL Hit 4", "BSL Hit 5", "BSL Hit 6", "BSL Hit 7", "BSL Hit 8",
      "BSL Hous 1", "BSL Hous 2", "BSL R&B 1", "BSL Rock 1",
      "BSW 10s 1", "BSW Comp 1", "BSW Comp 2", "BSW Comp 3", "BSW Hit 1", "BSW Hit 2", "BSW Hit 3", "BSW Hit 4", "BSW Hit 5", "BSW Hit 6", "BSW Hit 7", "BSW Hit 8",
      "BSW Hous 1", "BSW Hous 2", "BSW Hous 3", "BSW Jazz 1", "BSW L&S", "BSW MRN5", "BSW R&B 1", "BSW Regg 1", "BSW Rock 1", "BSW Soul 1",
      "BSWi BMLY", "BSWi HH 1", "BSWi Hous 1", "BSWi Hous 2", "BSWi Hous 3", "BSWi Hous 4", "BSWi Metal 1"
    ];

    // ... (‰ª•Èôç„ÄÅVer 55.0 „ÅÆ„Çπ„ÇØ„É™„Éó„Éà„Å®Âêå„ÅòÂÜÖÂÆπ)
    function hideModal(id) { document.getElementById(id).style.display = 'none'; if (id === 'winnerModal') document.getElementById('winnerListContainer').innerHTML = ''; }
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const resultElement = document.getElementById('result');
    const qrElement = document.getElementById('joinQr');
    const historyList = document.getElementById('historyList');
    const playerCounter = document.getElementById('playerCounter');
    let availableCandidates = [...candidates];
    let history = [];
    let lastGenre = null;
    let sameGenreCount = 0;
    let isAnimating = false;
    let animationInterval = null;
    let playersData = []; 
    let winnersData = []; 
    const PARTICIPANTS_PATH = 'bingo_game_final_v42';
    let initialWinnerKeys = new Set();

    window.onload = function() {
      document.addEventListener('click', async () => { try { if ('wakeLock' in navigator) await navigator.wakeLock.request('screen'); } catch(e) {} }, { once: true });
      db.ref('gameState/history').once('value').then(snapshot => {
        const savedHistory = snapshot.val();
        if(savedHistory) {
          const reversed = [...savedHistory].reverse();
          reversed.forEach(item => {
            const idx = availableCandidates.indexOf(item);
            if(idx > -1) availableCandidates.splice(idx, 1);
            updateGenreLogic(item);
            addToHistoryUI(item);
          });
          if(savedHistory.length > 0) {
            const latest = savedHistory[0];
            resultElement.textContent = latest;
            adjustFontSize(latest, true);
            applyStyle(resultElement, latest);
            qrElement.style.display = 'none';
          } else {
            qrElement.style.display = 'block';
          }
        }
      });
      db.ref(PARTICIPANTS_PATH).on('value', snap => {
        playersData = [];
        snap.forEach(child => { const val = child.val(); if(val) playersData.push(val); });
        updateCounter();
      });
      db.ref('winners').on('value', snap => {
        winnersData = [];
        snap.forEach(child => { const val = child.val(); if(val) winnersData.push(val); });
        updateCounter();
      });
      db.ref('winners').once('value', snap => {
          snap.forEach(child => { initialWinnerKeys.add(child.key); });
          db.ref('winners').on('child_added', (snapshot) => {
             if (!initialWinnerKeys.has(snapshot.key)) {
                 addWinnerPopup(snapshot.val().name);
                 initialWinnerKeys.add(snapshot.key);
             }
          });
      });
    };

    function runTestMode() {
        if(!confirm("„ÉÜ„Çπ„Éà„É¢„Éº„Éâ„ÇíÈñãÂßã„Åó„Åæ„Åô„ÅãÔºü")) return;
        let count = 0;
        const testInterval = setInterval(() => {
            if(count >= 50 || availableCandidates.length === 0) {
                clearInterval(testInterval);
                return;
            }
            const finalResult = drawRandomCandidate();
            resultElement.textContent = finalResult;
            adjustFontSize(finalResult, true);
            applyStyle(resultElement, finalResult);
            addToHistoryUI(finalResult);
            updateFirebase(finalResult);
            qrElement.style.display = 'none';
            count++;
        }, 200);
    }

    function updateCounter() {
      const uniquePlayers = new Set(playersData.map(p => p.name));
      const uniqueWinners = new Set(winnersData.map(w => w.name));
      let count = 0;
      uniquePlayers.forEach(p => { if (!uniqueWinners.has(p)) count++; });
      playerCounter.textContent = `PLAYERS: ${count}`;
    }

    function showPlayerList() {
      const listContainer = document.getElementById('playerListContent');
      listContainer.innerHTML = "";
      listContainer.className = "";
      const uniquePlayers = new Set(playersData.map(p => p.name));
      const total = uniquePlayers.size;
      if(total <= 15) listContainer.classList.add('grid-large'); 
      else if(total <= 30) listContainer.classList.add('grid-medium'); 
      else listContainer.classList.add('grid-small'); 
      const fontClass = total <= 15 ? 'font-large' : (total <= 30 ? 'font-medium' : 'font-small');

      if(total === 0) {
        listContainer.innerHTML = "<div style='color:#999; grid-column: 1 / -1;'>ÂèÇÂä†ËÄÖ„ÅØ„Åæ„Å†„ÅÑ„Åæ„Åõ„Çì</div>";
      } else {
        const winnerRankMap = {};
        winnersData.forEach((w, index) => { winnerRankMap[w.name] = index + 1; });
        let displayList = [];
        const addedWinners = new Set();
        winnersData.forEach((w) => {
           if(!addedWinners.has(w.name)) {
               addedWinners.add(w.name);
               displayList.push({ name: w.name, rank: addedWinners.size, isWinner: true });
           }
        });
        uniquePlayers.forEach(name => {
           if(!winnerRankMap[name]) displayList.push({ name: name, rank: null, isWinner: false });
        });
        displayList.forEach(item => {
          const div = document.createElement('div');
          div.className = `player-tile ${fontClass}`;
          if(item.isWinner) {
             div.classList.add('is-winner');
             div.innerHTML = `<span>üëë No.${item.rank}<br>${item.name}</span>`;
          } else {
             div.textContent = item.name;
          }
          listContainer.appendChild(div);
        });
      }
      document.getElementById('playerListModal').style.display = 'flex';
    }

    function resetGame() {
      if(!confirm("„Ç≤„Éº„É†„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü\nÔºàÂèÇÂä†ËÄÖ„É™„Çπ„Éà„Å®„Ç´„Éº„Éâ„ÅØÁ∂≠ÊåÅ„Åï„Çå„Åæ„ÅôÔºâ")) return;
      db.ref('gameState').remove();
      db.ref('winners').remove();
      qrElement.style.display = 'block';
      location.reload();
    }

    function resetAllData() {
      if(!confirm("‚ö† DANGER ‚ö†\nÂèÇÂä†ËÄÖ„É™„Çπ„Éà„ÇÇÂê´„ÇÅ„Å¶ÂÖ®„Å¶Âº∑Âà∂Ê∂àÂéª„Åó„Åæ„Åô„ÄÇ\nÊú¨ÂΩì„Å´ÂÆüË°å„Åó„Åæ„Åô„ÅãÔºü")) return;
      db.ref('gameState').remove();
      db.ref('winners').remove();
      db.ref(PARTICIPANTS_PATH).remove();
      qrElement.style.display = 'block';
      location.reload();
    }

    function addWinnerPopup(name) {
      const container = document.getElementById('winnerListContainer');
      const modal = document.getElementById('winnerModal');
      const div = document.createElement('div');
      div.className = 'winner-name-item';
      div.textContent = name;
      container.appendChild(div);
      modal.style.display = 'flex';
    }

    resultElement.addEventListener('click', performDraw);
    qrElement.addEventListener('click', performDraw);

    function getGenre(text) {
      if (text.startsWith("FEEL")) return "FEEL";
      if (text.startsWith("L 24") || text.startsWith("L 25")) return "LIMITED";
      if (text.startsWith("BSW")) return "BSW";
      if (text.startsWith("BSB")) return "BSB";
      if (text.startsWith("BSL")) return "BSL";
      if (text.startsWith("BB3")) return "BB3";
      if (text.startsWith("BB2")) return "BB2";
      if (text.startsWith("BB1")) return "BB1";
      if (text.includes("SP") || text.startsWith("ITS") || text === "ZEDD MIX" || text === "BEERCYCLE" || text === "SKRILLEX") return "SP";
      return "OTHER";
    }

    function updateGenreLogic(selectedCandidate) {
      const currentGenre = getGenre(selectedCandidate);
      if (currentGenre === lastGenre) sameGenreCount++; else sameGenreCount = 1;
      lastGenre = currentGenre;
    }

    function drawRandomCandidate() {
      let selectedCandidate;
      let selectedIndex;
      if (lastGenre !== null) {
        let needDifferentGenre = false;
        if (lastGenre === "BB2" && sameGenreCount >= 2) needDifferentGenre = true;
        else if (lastGenre !== "BB2" && sameGenreCount >= 1) needDifferentGenre = true;
        
        if (needDifferentGenre) {
          const diff = availableCandidates.filter(c => getGenre(c) !== lastGenre);
          if (diff.length > 0) {
            selectedCandidate = diff[Math.floor(Math.random() * diff.length)];
            selectedIndex = availableCandidates.indexOf(selectedCandidate);
          }
        }
      }
      if (!selectedCandidate) {
        selectedIndex = Math.floor(Math.random() * availableCandidates.length);
        selectedCandidate = availableCandidates[selectedIndex];
      }
      availableCandidates.splice(selectedIndex, 1);
      updateGenreLogic(selectedCandidate);
      return selectedCandidate;
    }

    function performDraw() {
      if (isAnimating) return;
      if (availableCandidates.length === 0) {
        resultElement.textContent = "ALL COMPLETED!";
        applyStyle(resultElement, "");
        qrElement.style.display = 'none';
        return;
      }
      qrElement.style.display = 'none';
      isAnimating = true;
      const finalResult = drawRandomCandidate();

      animationInterval = setInterval(() => {
        const temp = availableCandidates[Math.floor(Math.random() * availableCandidates.length)] || finalResult;
        resultElement.textContent = temp;
        adjustFontSize(temp, false); 
        applyStyle(resultElement, temp);
      }, 100);

      setTimeout(() => {
        clearInterval(animationInterval);
        resultElement.textContent = finalResult;
        adjustFontSize(finalResult, true);
        applyStyle(resultElement, finalResult);
        addToHistoryUI(finalResult);
        updateFirebase(finalResult);
        isAnimating = false;
        if (availableCandidates.length === 0) setTimeout(() => alert("ÂÖ®„Å¶„ÅÆ„Éó„É≠„Ç∞„É©„É†„ÅåÁµÇ‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ"), 1000);
      }, 1300);
    }

    function adjustFontSize(text, isFinal) {
        const maxW = window.innerWidth * 0.95;
        let size = 9;
        if(text.length > 14) size = 4.5;
        else if(text.length > 10) size = 6.5;
        else if(text.length > 7) size = 8;
        
        resultElement.style.fontSize = size + 'rem';

        if (isFinal) {
            setTimeout(() => {
                let currentSize = parseFloat(resultElement.style.fontSize);
                let safety = 0;
                while (resultElement.scrollWidth > maxW && currentSize > 1 && safety < 50) {
                    currentSize -= 0.2;
                    resultElement.style.fontSize = currentSize + 'rem';
                    safety++;
                }
            }, 0);
        }
    }

    function updateFirebase(result) {
      db.ref('gameState/history').once('value').then(snapshot => {
        const currentHistory = snapshot.val() || [];
        const newHistory = [result, ...currentHistory];
        db.ref('gameState').set({ history: newHistory, lastUpdate: Date.now() });
      });
    }

    function addToHistoryUI(item) {
      const li = document.createElement('li');
      li.textContent = item;
      applyStyle(li, item, true);
      const list = document.getElementById('historyList');
      list.prepend(li);
      if (history.length > 5) history.pop();
      if (list.children.length > 5) list.removeChild(list.lastChild);
    }

    function applyStyle(element, text, isHistoryItem = false) {
      element.removeAttribute('style'); element.removeAttribute('class');
      let bgColor = 'transparent'; let textColor = 'white';
      if (text.startsWith("BB1")) { bgColor = '#FFFF00'; textColor = 'black'; }
      else if (text.startsWith("BB2")) { bgColor = '#FF9933'; textColor = 'black'; }
      else if (text.startsWith("BB3")) { bgColor = '#FF3300'; textColor = 'black'; }
      else if (text.startsWith("BSBi")) { bgColor = '#336699'; textColor = '#DEFF66'; }
      else if (text.startsWith("BSB")) { bgColor = '#00CCFF'; textColor = 'black'; }
      else if (text.startsWith("BSWi")) { bgColor = '#990099'; textColor = '#FFEF7F'; }
      else if (text.startsWith("BSW")) { bgColor = '#CC66FF'; textColor = 'white'; }
      else if (text.startsWith("BSL")) { bgColor = '#0000CC'; textColor = 'white'; }
      else if (text.includes("FEEL NOW G")) { bgColor = '#B08A3A'; textColor = 'white'; }
      else if (text.includes("FEEL NOW S")) { bgColor = '#666666'; textColor = 'white'; }
      else if (text.includes("FEEL NOW B")) { bgColor = '#00121C'; textColor = 'white'; }
      else if (text.includes("FEEL HIGH")) { bgColor = 'white'; textColor = 'black'; }
      else if (text.includes("FEEL DEEP")) { bgColor = 'white'; textColor = 'black'; }
      else if (text.includes("BTM")) { bgColor = '#00121C'; textColor = '#BD3EA4'; }
      else if (text.includes("FREE")) { bgColor = '#00121C'; textColor = '#D61C1C'; }
      else if (text.startsWith("FEEL NOW")) { bgColor = '#00121C'; textColor = 'white'; }
      else if (text.includes("FEEL")) { bgColor = '#00121C'; textColor = '#0761F1'; }
      else if (text.includes("SP")) { bgColor = '#00121C'; textColor = 'white'; }
      else if (text === "BEERCYCLE") { bgColor = '#7A3202'; textColor = 'white'; }
      else if (text === "SKRILLEX") { bgColor = 'white'; textColor = 'black'; }
      
      element.style.backgroundColor = bgColor; element.style.color = textColor;
      if (!isHistoryItem) { 
          element.style.padding = '20px 40px'; element.style.cursor = 'pointer'; 
          element.style.borderRadius = '10px';
      }
      else { element.style.padding = '5px 15px'; element.style.display = 'inline-block'; element.style.margin = '3px'; element.style.borderRadius = '5px'; }
    }
  </script>
</body>
</html>
