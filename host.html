<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BNK2025 - HOST FINAL</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <style>
    @font-face {
      font-family: 'BrotherXL';
      src: url('./fonts/Brother_XL_Regular.otf') format('opentype');
      font-weight: normal;
      font-style: normal;
    }

    body {
      font-family: 'BrotherXL', Arial, sans-serif;
      margin: 0; padding: 0;
      background-color: black;
      background-image: url('./FC_logo.png');
      background-repeat: no-repeat;
      background-position: center center;
      background-attachment: fixed;
      background-size: cover;
      display: flex; justify-content: center; align-items: center;
      flex-direction: column; height: 100vh; color: white;
      position: relative; overflow: hidden;
    }

    .version-tag { position: absolute; top: 5px; right: 5px; font-size: 0.7rem; color: #aaa; z-index: 2000; font-family: sans-serif; }

    .container {
      text-align: center; width: 100%;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
    }

    #result {
      font-size: 9rem; font-weight: bold; margin-bottom: 10px;
      display: inline-block; cursor: pointer;
      text-shadow: 0 0 10px rgba(0,0,0,0.5);
      min-height: 1.2em; line-height: 1.2; z-index: 10;
    }
    #result:active { transform: scale(0.98); }

    #joinQr {
      width: 220px; height: 220px; margin: 20px auto;
      border: 6px solid white; border-radius: 15px;
      display: block; box-shadow: 0 0 30px rgba(255,255,255,0.4); cursor: pointer;
      transition: transform 0.1s;
    }
    #joinQr:active { transform: scale(0.95); }

    #historyContainer {
      margin-top: 20px; margin-bottom: 20px;
      font-size: 2.1rem; text-align: center; min-height: 80px;
    }
    #historyList { list-style: none; padding: 0; margin: 0; }
    #historyList li { margin: 3px; display: inline-block; }

    #linkButton {
      position: fixed; left: 30px; bottom: 30px; width: 80px; height: 80px;
      background: transparent; border: 1px solid rgba(255, 255, 255, 0.1);
      cursor: pointer; transition: all 0.3s ease; text-decoration: none;
      z-index: 1000; display: block;
    }
    #linkButton:hover { border-color: rgba(255, 255, 255, 0.3); transform: scale(1.05); }

    #resetButton {
      position: fixed; top: 20px; right: 20px;
      background: rgba(0, 0, 0, 0.5); color: #aaa;
      border: 1px solid #555; padding: 5px 10px;
      font-size: 0.8rem; cursor: pointer; z-index: 1000;
    }
    #resetButton:hover { background: red; color: white; }

    #playerCounter {
      position: fixed; top: 20px; left: 20px;
      font-size: 1.5rem; font-weight: bold; color: rgba(255,255,255,0.8);
      text-shadow: 0 0 5px black; z-index: 1000;
      cursor: pointer; padding: 5px 10px; border-radius: 5px;
      transition: background 0.3s;
    }
    #playerCounter:hover { background: rgba(255, 255, 255, 0.2); color: white; }

    .modal-overlay {
      display: none; position: fixed; top: 0; left: 0; 
      width: 100%; height: 100%; background: rgba(0,0,0,0.95);
      z-index: 2000; flex-direction: column; 
      justify-content: center; align-items: center;
    }
    .close-modal { 
      padding: 10px 30px; font-size: 1.5rem; margin-top: 30px;
      background: transparent; border: 2px solid white; 
      color: white; cursor: pointer; border-radius: 30px;
      position: relative; z-index: 3000;
    }

    .bingo-text { font-size: 8rem; font-weight: bold; color: #FF3300; margin-bottom: 20px; animation: popIn 0.5s; }
    #winnerListContainer {
      display: flex; flex-direction: column; align-items: center;
      max-height: 60vh; overflow-y: auto; width: 100%;
    }
    .winner-name-item { 
      font-size: 5rem; color: white; margin: 10px 0;
      text-shadow: 0 0 20px #FF9933; animation: slideUp 0.5s ease-out;
    }

    .player-list-title { font-size: 3rem; font-weight: bold; color: #FF9933; margin-bottom: 30px; }
    
    #playerListContent {
      display: grid; gap: 15px;
      width: 90%; max-width: 1200px;
      max-height: 70vh; overflow-y: auto; padding: 20px;
      grid-template-columns: repeat(4, 1fr);
    }
    .grid-large { grid-template-columns: repeat(3, 1fr) !important; }
    .grid-medium { grid-template-columns: repeat(4, 1fr) !important; }
    .grid-small { grid-template-columns: repeat(5, 1fr) !important; }

    .player-tile {
      background: #222; border: 1px solid #555; border-radius: 15px;
      display: flex; justify-content: center; align-items: center;
      text-align: center; padding: 15px;
      color: #ddd; font-weight: bold;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      transition: transform 0.2s;
    }
    .player-tile:hover { transform: translateY(-2px); border-color: #888; }

    .player-tile.is-winner {
      background: linear-gradient(135deg, #332200, #664400);
      border: 2px solid #FFD700; color: #FFD700;
      box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
    }

    .font-large { font-size: 2.5rem; height: 100px; }
    .font-medium { font-size: 1.8rem; height: 80px; }
    .font-small { font-size: 1.2rem; height: 60px; }

    @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }
    @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  </style>
</head>
<body>
  <div class="version-tag">Ver 34.0 (Host Fixed)</div>

  <button id="resetButton" onclick="resetGame()">RESET</button>
  <div id="playerCounter" onclick="showPlayerList()">PLAYERS: 0</div>

  <div class="container">
    <p id="result">ARE U READY?</p>
    <img id="joinQr" src="./qr-code.png" alt="Join Game" onclick="performDraw()">
    <div id="historyContainer">
      <p style="font-size:1rem; margin:0; opacity:0.7;">Past Results:</p>
      <ul id="historyList"></ul>
    </div>
  </div>

  <a href="https://gateofzen.github.io/screen/" target="_blank" id="linkButton"></a>

  <div id="winnerModal" class="modal-overlay">
    <div class="bingo-text">BINGO!!!</div>
    <div id="winnerListContainer"></div>
    <button class="close-modal" onclick="hideModal('winnerModal')">CLOSE</button>
  </div>

  <div id="playerListModal" class="modal-overlay">
    <div class="player-list-title">PARTICIPANTS</div>
    <div id="playerListContent"></div>
    <button class="close-modal" onclick="hideModal('playerListModal')">CLOSE</button>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDNPT6qv47ku9PBYLm_9FDl-hY0sQqZHn8",
      authDomain: "bnk2025-bingo.firebaseapp.com",
      databaseURL: "https://bnk2025-bingo-default-rtdb.firebaseio.com",
      projectId: "bnk2025-bingo",
      storageBucket: "bnk2025-bingo.firebasestorage.app",
      messagingSenderId: "127094139624",
      appId: "1:127094139624:web:703cf76da95ba05154b75d",
      measurementId: "G-2LVWF4GVS5"
    };

    // candidates„É™„Çπ„Éà (ÁúÅÁï•)
    const candidates = [];

    function hideModal(id) {
      document.getElementById(id).style.display = 'none';
    }

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const resultElement = document.getElementById('result');
    const qrElement = document.getElementById('joinQr');
    const historyList = document.getElementById('historyList');
    const playerCounter = document.getElementById('playerCounter');

    let availableCandidates = []; // ÁúÅÁï•Ôºà„Éó„É≠„Ç∞„É©„É†„É™„Çπ„Éà„ÅØ player „Å®Âêå„Åò„ÇÇ„ÅÆ„Çí‰ΩøÁî®Ôºâ
    let history = [];
    let lastGenre = null;
    let sameGenreCount = 0;
    let isAnimating = false;
    let animationInterval = null;
    
    let playersData = []; 
    let winnersData = []; 
    
    // ‚òÖÈáçË¶Å: „Éó„É¨„Ç§„É§„Éº„Å®Âêå„Åò„Éë„Çπ
    const PARTICIPANTS_PATH = 'bingo_v34_final';

    window.onload = function() {
      db.ref('gameState/history').once('value').then(snapshot => {
        const savedHistory = snapshot.val();
        if(savedHistory) {
          // ... (Â±•Ê≠¥Âæ©ÂÖÉ)
           qrElement.style.display = 'none';
        }
      });

      // ‚òÖ‰øÆÊ≠£: Ê≠£„Åó„ÅÑ„Éë„Çπ„ÇíÁõ£Ë¶ñ
      db.ref(PARTICIPANTS_PATH).on('value', snap => {
        playersData = [];
        snap.forEach(child => {
            const val = child.val();
            if(val) playersData.push(val);
        });
        updateCounter();
      });

      db.ref('winners').on('value', snap => {
        winnersData = [];
        snap.forEach(child => {
            const val = child.val();
            if(val) winnersData.push(val);
        });
        updateCounter();
      });
      
      // ...
    };

    // ... (ÁúÅÁï•: updateCounter, showPlayerList, performDraw, etc) ...
    // ‰ª•Ââç„ÅÆ„Ç≥„Éº„Éâ„Å®„É≠„Ç∏„ÉÉ„ÇØ„ÅØÂêå„Åò„Åß„Åô„Åå„ÄÅPARTICIPANTS_PATH„Åå‰øÆÊ≠£„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ

    function updateCounter() {
      const uniquePlayers = new Set(playersData.map(p => p.name));
      const uniqueWinners = new Set(winnersData.map(w => w.name));
      let count = 0;
      uniquePlayers.forEach(p => { if (!uniqueWinners.has(p)) count++; });
      playerCounter.textContent = `PLAYERS: ${count}`;
    }

    function showPlayerList() {
      // ... (ÂâçÂõû„ÅÆ„É™„Çπ„ÉàË°®Á§∫„É≠„Ç∏„ÉÉ„ÇØ) ...
      const listContainer = document.getElementById('playerListContent');
      listContainer.innerHTML = "";
      listContainer.className = "";
      const uniquePlayers = new Set(playersData.map(p => p.name));
      const total = uniquePlayers.size;
      if(total <= 15) listContainer.classList.add('grid-large'); 
      else if(total <= 30) listContainer.classList.add('grid-medium'); 
      else listContainer.classList.add('grid-small'); 
      const fontClass = total <= 15 ? 'font-large' : (total <= 30 ? 'font-medium' : 'font-small');

      if(total === 0) {
        listContainer.innerHTML = "<div style='color:#999; grid-column: 1 / -1;'>ÂèÇÂä†ËÄÖ„ÅØ„Åæ„Å†„ÅÑ„Åæ„Åõ„Çì</div>";
      } else {
        const winnerRankMap = {};
        winnersData.forEach((w, index) => { winnerRankMap[w.name] = index + 1; });
        let displayList = [];
        const addedWinners = new Set();
        winnersData.forEach((w) => {
           if(!addedWinners.has(w.name)) {
               addedWinners.add(w.name);
               displayList.push({ name: w.name, rank: addedWinners.size, isWinner: true });
           }
        });
        uniquePlayers.forEach(name => {
           if(!winnerRankMap[name]) displayList.push({ name: name, rank: null, isWinner: false });
        });
        displayList.forEach(item => {
          const div = document.createElement('div');
          div.className = `player-tile ${fontClass}`;
          if(item.isWinner) {
             div.classList.add('is-winner');
             div.innerHTML = `<span>üëë No.${item.rank}<br>${item.name}</span>`;
          } else {
             div.textContent = item.name;
          }
          listContainer.appendChild(div);
        });
      }
      document.getElementById('playerListModal').style.display = 'flex';
    }

    function resetGame() {
      if(!confirm("„Ç≤„Éº„É†„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü")) return;
      db.ref('gameState').remove();
      db.ref('winners').remove();
      db.ref(PARTICIPANTS_PATH).remove();
      qrElement.style.display = 'block';
      location.reload();
    }
    
    // ... (ÁúÅÁï•: ÊÆã„Çä„ÅÆÈñ¢Êï∞„ÅØVer33„Å®Âêå„Åò) ...
  </script>
</body>
</html>
