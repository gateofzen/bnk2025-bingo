<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>BINGO PLAYER</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <style>
    @font-face {
      font-family: 'BrotherXL';
      src: url('./fonts/Brother_XL_Regular.otf') format('opentype');
      font-weight: normal;
      font-style: normal;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body { 
      background-color: black; 
      background-image: url('./FC_logo.png');
      background-repeat: no-repeat;
      background-position: center center;
      background-attachment: fixed;
      background-size: cover;
      color: white; 
      font-family: 'BrotherXL', sans-serif;
      min-height: 100vh; margin: 0; padding-bottom: 80px;
      touch-action: manipulation;
      overscroll-behavior-y: none;
    }

    .version-tag { position: absolute; top: 5px; right: 5px; font-size: 0.7rem; color: #aaa; z-index: 2000; font-family: sans-serif; }

    #loginScreen { 
      position: fixed; top:0; left:0; width:100%; height:100%; 
      background: rgba(0,0,0,0.9); 
      z-index: 999; display: flex; flex-direction: column; 
      justify-content: center; align-items: center; 
    }
    input[type="text"] { 
      font-size: 1.5rem; padding: 15px; text-align: center; width: 80%; max-width: 300px;
      border-radius: 8px; border: none; margin-bottom: 30px; 
      font-family: 'BrotherXL', sans-serif;
    }
    .btn-start { 
      padding: 15px 60px; font-size: 1.3rem; font-weight: bold;
      background: linear-gradient(45deg, #FF9933, #FFCC00); 
      border: none; border-radius: 50px; cursor: pointer; color: black;
      box-shadow: 0 4px 15px rgba(255, 153, 51, 0.4);
      font-family: 'BrotherXL', sans-serif;
    }

    .container { max-width: 500px; margin: 0 auto; text-align: center; padding-top: 20px; }
    
    .bingo-grid {
      display: grid; 
      grid-template-columns: repeat(3, 1fr); 
      grid-template-rows: repeat(3, 1fr);
      gap: 8px;
      width: 92vw; 
      max-width: 400px; 
      aspect-ratio: 1 / 1;
      margin: 10px auto 20px auto;
    }

    .bingo-cell {
      background: rgba(34, 34, 34, 0.9); 
      border: 1px solid #444; 
      border-radius: 12px;
      width: 100%;
      height: 100%;
      display: flex; 
      justify-content: center; 
      align-items: center;     
      font-size: 0.85rem; 
      font-weight: bold; 
      line-height: 1.1;
      text-align: center; 
      word-break: break-word; 
      padding: 2px; 
      cursor: pointer; 
      user-select: none; 
      position: relative;
      transition: opacity 0.3s ease;
    }
    .bingo-cell.hit { 
      border: 3px solid #fff; 
      box-shadow: 0 0 20px rgba(255,255,255,0.5); 
      z-index: 10; 
      opacity: 1; /* ヒット時は透明にしない */
      transform: scale(1.02);
    }
    /* HITスタンプ */
    .bingo-cell.hit::after {
      content: "HIT!";
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%) rotate(-15deg);
      font-size: 2.5rem; color: #FF0000; font-weight: 900;
      text-shadow: 2px 2px 0 #FFF, -1px -1px 0 #FFF, 1px -1px 0 #FFF, -1px 1px 0 #FFF, 1px 1px 0 #FFF;
      border: 3px solid #FF0000; padding: 2px 8px; border-radius: 8px;
      background-color: rgba(255, 255, 255, 0.8);
      pointer-events: none; white-space: nowrap; font-family: sans-serif;
      box-shadow: 3px 3px 5px rgba(0,0,0,0.5);
      animation: stampIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    @keyframes stampIn {
      from { transform: translate(-50%, -50%) scale(2) rotate(-15deg); opacity: 0; }
      to { transform: translate(-50%, -50%) scale(1) rotate(-15deg); opacity: 1; }
    }
    
    .btn-random {
      background: #336699; color: #DEFF66; padding: 15px 0; 
      border: none; border-radius: 12px; font-size: 1.1rem; 
      font-weight: bold; cursor: pointer; width: 92vw; max-width: 400px;
      margin-bottom: 10px; letter-spacing: 1px;
      font-family: 'BrotherXL', sans-serif;
    }
    .btn-random.disabled { opacity: 0.5; cursor: not-allowed; }

    #status {
      color: #FFFF00; font-size: 1.2rem; margin: 15px 0; 
      min-height: 40px; font-weight: bold;
      display: flex; justify-content: center; align-items: center;
    }
    .status-badge {
      display: inline-block; padding: 5px 15px; margin-left: 10px;
      border-radius: 0;
      font-size: 1rem; color: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.5);
    }

    .modal { 
      display: none; position: fixed; top: 0; left: 0; 
      width: 100%; height: 100%; background: rgba(0,0,0,0.95); 
      z-index: 1000; flex-direction: column; 
    }
    .modal-header { padding: 15px; background: #111; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
    .btn-close { 
      background: #333; color: white; border: none; padding: 8px 20px; border-radius: 6px; font-size: 0.9rem; 
      font-family: 'BrotherXL', sans-serif;
    }
    
    .genre-tabs { display: flex; overflow-x: auto; background: transparent; padding: 15px 10px; white-space: nowrap; }
    .genre-tab { display: inline-block; padding: 8px 18px; margin-right: 8px; background: #222; border-radius: 20px; color: #888; font-size: 0.9rem; border: 1px solid #333; cursor: pointer; }
    .genre-tab.active { background: #eee; color: #000; font-weight: bold; border-color: #fff; }
    
    .list-container { flex: 1; overflow-y: auto; padding: 10px; padding-bottom: 100px; }
    .list-item { padding: 15px; margin-bottom: 10px; background: #1a1a1a; border-radius: 8px; border: 1px solid #333; text-align: left; display: flex; justify-content: space-between; align-items: center; }
    .list-item.disabled { 
      opacity: 1 !important; 
      pointer-events: none !important; 
      background-color: #000 !important; 
      border-color: #555 !important;
      color: #444 !important;
    }
    .selected-badge { color: #ff5555; font-weight: bold; font-size: 0.75rem; display: none; font-family: sans-serif; }
    .list-item.disabled .selected-badge { display: block; opacity: 0.7; }

    .bingo-overlay {
      display: none; position: fixed; top: 0; left: 0;
      width: 100%; height: 100%; background: rgba(0,0,0,0.95);
      z-index: 2000; flex-direction: column;
      justify-content: center; align-items: center;
      animation: fadeIn 0.3s;
    }
    .bingo-text {
      font-size: 5rem; font-weight: bold; color: #FF3300;
      text-shadow: 0 0 20px #FF9933;
      margin-bottom: 20px; animation: popIn 0.5s;
    }
    @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    
    .close-bingo-btn {
      padding: 10px 30px; font-size: 1.2rem; margin-top: 30px;
      background: transparent; border: 2px solid white;
      color: white; cursor: pointer; border-radius: 30px;
      font-family: 'BrotherXL', sans-serif;
    }

    .footer-menu {
      position: fixed; bottom: 0; left: 0; width: 100%; height: 60px;
      background: rgba(0,0,0,0.8); border-top: 1px solid #333;
      display: flex; justify-content: center; align-items: center; gap: 20px;
      z-index: 1500;
    }
    .footer-btn {
      background: transparent; border: 1px solid #555; color: #aaa;
      padding: 5px 15px; border-radius: 20px; font-size: 0.7rem;
      cursor: pointer; font-family: sans-serif;
    }
    .footer-btn:hover { background: #333; color: white; }
    .btn-exit { border-color: #662222; color: #cc6666; }
    .btn-exit:hover { background: #331111; color: red; }
  </style>
</head>
<body>
  <div class="version-tag">Ver 32.0 (Path Fixed)</div>

  <div id="loginScreen">
    <h2 style="color:#FF9933; margin-bottom:40px; letter-spacing:2px;">BINGO ENTRY</h2>
    <input type="text" id="playerName" placeholder="NAME">
    <button class="btn-start" onclick="startGame()">GAME START</button>
  </div>

  <div id="gameScreen" class="container" style="display:none;">
    <h2 id="displayName" style="margin:0; font-size:1.4rem; color:#ddd;">PLAYER</h2>
    
    <div id="status">READY...</div>
    
    <div class="controls">
      <button class="btn-random" id="randomFillButton" onclick="randomFill()">AUTO FILL (RANDOM)</button>
      <p style="color:#aaa; font-size:0.8rem; margin-top:8px; font-family:sans-serif;">開始後は変更できません</p>
    </div>
    <div class="bingo-grid" id="grid"></div>
  </div>

  <div class="footer-menu">
    <button class="footer-btn" onclick="manualRefresh()">↻ REFRESH</button>
    <button class="footer-btn btn-exit" onclick="exitAndClear()">⚠ EXIT & CLEAR</button>
  </div>

  <div id="myBingoModal" class="bingo-overlay">
    <div class="bingo-text">BINGO!!!</div>
    <div style="font-size: 1.5rem; margin-top: 20px;">CONGRATULATIONS!</div>
    <button class="close-bingo-btn" onclick="closeModal('myBingoModal')">CLOSE</button>
  </div>

  <div id="selectorModal" class="modal">
    <div class="modal-header">
      <span style="font-weight:bold; font-size:1.1rem;">SELECT PROGRAM</span>
      <button class="btn-close" onclick="closeModal('selectorModal')">CLOSE</button>
    </div>
    <div class="genre-tabs" id="genreTabs"></div>
    <div class="list-container" id="programList"></div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDNPT6qv47ku9PBYLm_9FDl-hY0sQqZHn8",
      authDomain: "bnk2025-bingo.firebaseapp.com",
      databaseURL: "https://bnk2025-bingo-default-rtdb.firebaseio.com",
      projectId: "bnk2025-bingo",
      storageBucket: "bnk2025-bingo.firebasestorage.app",
      messagingSenderId: "127094139624",
      appId: "1:127094139624:web:703cf76da95ba05154b75d",
      measurementId: "G-2LVWF4GVS5"
    };
    
    const candidates = [
      "BB1 10s 1", "BB1 10s 2", "BB1 90s 1", "BB1 BRIT 2024", "BB1 Comp 1", "BB1 Comp 2", "BB1 Comp 3", "BB1 Comp 4", "BB1 DVGT", "BB1 GRMY 65", "BB1 GRMY 67",
      "BB1 Hit 1", "BB1 Hit 2", "BB1 Hit 3", "BB1 Hit 4", "BB1 Hit 5", "BB1 Hit 6", "BB1 Hit 7", "BB1 Hit 8", "BB1 Hit 9", "BB1 Hit 10", "BB1 Hit 11",
      "BB1 Hous 1", "BB1 Hous 2", "BB1 Hous 3", "BB1 Hous 4", "BB1 Hous 5", "BB1 NOW 1", "BB1 NOW 2", "BB1 Queen", "BB1 TSFT",
      "FEEL NOW B1", "FEEL NOW B2", "FEEL NOW B3", "FEEL NOW B4", "FEEL NOW G1", "FEEL NOW G2", "FEEL NOW G3", "FEEL NOW S1", "FEEL NOW S2", "FEEL NOW S3",
      "8th SP", "9th SP 1", "9th SP 2", "10th SP",
      "BB2 10s 1", "BB2 10s 2", "BB2 10s 3", "BB2 10s 4", "BB2 1D", "BB2 2016", "BB2 2017", "BB2 2018", "BB2 2019", "BB2 3Y-1", "BB2 3Y-2",
      "BB2 90s 1", "BB2 90s 2", "BB2 ADELE", "BB2 ARGD", "BB2 Avicii", "BB2 BEYONCE", "BB2 BMLY", "BB2 BNJV", "BB2 BRIT 2023", "BB2 BRIT 2025",
      "BB2 BRJ", "BB2 BRMS", "BB2 BRMS 2", "BB2 BTLS 1", "BB2 BTLS 2", "BB2 BTLS 3", "BB2 CDPY", "BB2 CDPY 2", "BB2 CHARLI",
      "BB2 Comp 1", "BB2 Comp 2", "BB2 Comp 3", "BB2 Comp 4", "BB2 Comp 5", "BB2 Comp 6", "BB2 Comp 7", "BB2 CSBW", "BB2 CSBW 2", "BB2 CVHS",
      "BB2 Deep 1", "BB2 Deep 2", "BB2 Deep 3", "BB2 Dua Lipa", "BB2 Dua Lipa 2", "BB2 DVGT", "BB2 EDM",
      "BB2 EDSR", "BB2 EMINEM", "BB2 FLG", "BB2 FOB", "BB2 GRDY", "BB2 GRMY 66",
      "BB2 Hit 1", "BB2 Hit 2", "BB2 Hit 3", "BB2 Hit 4", "BB2 Hit 5", "BB2 Hit 6", "BB2 Hit 7", "BB2 Hit 8", "BB2 Hit 9", "BB2 Hit 10",
      "BB2 Hit 11", "BB2 Hit 12", "BB2 Hit 13", "BB2 Hit 14", "BB2 Hit 15", "BB2 Hit 16", "BB2 Hit 17", "BB2 Hit 18", "BB2 Hit 19", "BB2 Hit 20", "BB2 Hit 21", "BB2 Hit 22",
      "BB2 HH 1", "BB2 HH 2", "BB2 Hous 1", "BB2 Hous 2", "BB2 Hous 3", "BB2 Hous 4", "BB2 Hous 6", "BB2 Hous 7",
      "BB2 Jazz 1", "BB2 JONAS", "BB2 JUSTIN", "BB2 KYGO", "BB2 LDGG", "BB2 LDGG 2", "BB2 MDNA", "BB2 MRN5", "BB2 MTGX", "BB2 Metal 1", "BB2 Metal 2",
      "BB2 MJ 1", "BB2 MJ 2", "BB2 MJ 3", "BB2 MLN 1", "BB2 MLN 2", "BB2 MLN 3", "BB2 Movie 1", "BB2 Movie 2", "BB2 NE-YO", "BB2 NOW 1", "BB2 NOW 2",
      "BB2 P!NK", "BB2 PTX", "BB2 QOP", "BB2 Queen", "BB2 R&B 1", "BB2 R&B 2", "BB2 Regg 1", "BB2 Regg 2", "BB2 RHCP", "BB2 RHNA", "BB2 Rock 1", "BB2 Rock 2",
      "BB2 SIGALA", "BB2 SMST", "BB2 Soul 1", "BB2 Soul 2", "BB2 SUMR 1", "BB2 SUMR 2", "BB2 UPGD 1", "BB2 UPGD 2", "BB2 UPGD 3", "BB2 USHER", "BB2 USHER 2",
      "BB2 Xmas 2", "BB2 Xmas 3", "BB2 Xmas 4", "BB2 ZEDD", "SKRILLEX", "BEERCYCLE", "FEEL DEEP", "FEEL HIGH",
      "L 25 BTM", "L 25 FEEL", "L 25 FREE",
      "BB3 10s 1", "BB3 Comp 1", "BB3 Deep 1", "BB3 HH 1", "BB3 HH 2", "BB3 Hit 1", "BB3 Hit 2", "BB3 Hit 3", "BB3 Hit 4", "BB3 Hit 5", "BB3 Hit 6",
      "BB3 Hous 1", "BB3 Hous 2", "BB3 Hous 3", "BB3 Hous 4", "BB3 IRMD", "BB3 Regg 1", "BB3 Rock 1", "BB3 Rock 2", "BB3 Soul 1", "BB3 UPGD 1", "BB3 World 1",
      "BSB 10s 1", "BSB Comp 1", "BSB Deep 1", "BSB HH 2", "BSB Hit 1", "BSB Hit 2", "BSB Hit 3", "BSB Hit 4", "BSB Hit 5", "BSB Hit 6", "BSB Hit 7",
      "BSB Hous 1", "BSB Jazz 1", "BSB Regg 1", "BSB Rock 1", "BSBi BMLY", "BSBi Deep 1", "BSBi Hous 1", "BSBi Hous 2",
      "L 24 FEEL", "L 24 FEEL 2", "L 24 FREE", "L 24 FREE 2",
      "BSL Comp 1", "BSL Deep 1", "BSL Deep 2", "BSL Deep 3", "BSL Deep 4", "BSL Hit 1", "BSL Hit 2", "BSL Hit 3", "BSL Hit 4", "BSL Hit 5", "BSL Hit 6", "BSL Hit 7", "BSL Hit 8",
      "BSL Hous 1", "BSL Hous 2", "BSL R&B 1", "BSL Rock 1",
      "BSW 10s 1", "BSW Comp 1", "BSW Comp 2", "BSW Comp 3", "BSW Hit 1", "BSW Hit 2", "BSW Hit 3", "BSW Hit 4", "BSW Hit 5", "BSW Hit 6", "BSW Hit 7", "BSW Hit 8",
      "BSW Hous 1", "BSW Hous 2", "BSW Hous 3", "BSW Jazz 1", "BSW L&S", "BSW R&B 1", "BSW Regg 1", "BSW Rock 1", "BSW Soul 1",
      "BSWi BMLY", "BSWi HH 1", "BSWi Hous 1", "BSWi Hous 2", "BSWi Hous 3", "BSWi Hous 4", "BSWi Metal 1"
    ];

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let myCard = new Array(9).fill(null);
    let playerName = "";
    let drawnHistory = [];
    let isBingo = false;
    let editingIndex = -1;
    let currentGenre = "BB1";
    let gameStarted = false; 
    
    // ★通信先を統一 (ここが原因でした)
    const PARTICIPANTS_PATH = 'bingo_game_v32';

    window.onload = function() {
      initGrid();
      // Wake Lock
      document.addEventListener('click', async () => {
        try {
          if ('wakeLock' in navigator) {
            await navigator.wakeLock.request('screen');
          }
        } catch(e) {}
      }, { once: true });
    };

    function initGrid() {
      const gridEl = document.getElementById('grid');
      gridEl.innerHTML = "";
      for(let i=0; i<9; i++) {
        const div = document.createElement('div');
        div.className = 'bingo-cell';
        div.innerHTML = "<span style='color:#999'>TAP</span>";
        div.onclick = openSelector.bind(null, i);
        gridEl.appendChild(div);
      }
    }

    async function requestWakeLock() {
      try {
        if ('wakeLock' in navigator) {
          const wakeLock = await navigator.wakeLock.request('screen');
          document.addEventListener('visibilitychange', async () => {
            if (wakeLock !== null && document.visibilityState === 'visible') {
              await navigator.wakeLock.request('screen');
            }
          });
        }
      } catch (err) { console.log("Wake Lock error"); }
    }

    function startGame() {
      const nameInput = document.getElementById('playerName');
      if(!nameInput.value.trim()) return alert("名前を入力してください");
      
      playerName = nameInput.value.trim();
      
      document.getElementById('displayName').textContent = playerName;
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('gameScreen').style.display = 'block';

      // ★プッシュ方式で登録（確実に増える）
      db.ref(PARTICIPANTS_PATH).push({
        name: playerName,
        timestamp: Date.now()
      });

      db.ref('gameState/history').on('value', (snapshot) => {
        if(isBingo) return;

        drawnHistory = snapshot.val() || [];
        const statusEl = document.getElementById('status');
        
        if(drawnHistory.length > 0) {
          gameStarted = true; 
          document.getElementById('randomFillButton').classList.add('disabled');
          
          statusEl.innerHTML = "LATEST: ";
          const badge = document.createElement('span');
          badge.className = "status-badge";
          badge.textContent = drawnHistory[0];
          badge.style.backgroundColor = getBgColor(drawnHistory[0]);
          badge.style.color = getTextColor(drawnHistory[0]);
          statusEl.appendChild(badge);
        } else {
          statusEl.textContent = "READY...";
          gameStarted = false; 
          document.getElementById('randomFillButton').classList.remove('disabled');
        }
        renderGrid();
      });

      requestWakeLock();
    }

    function manualRefresh() {
      if(gameStarted) {
         if(!confirm("ビンゴカードが消えてしまう可能性があります。\n再読み込みしますか？")) return;
      }
      location.reload();
    }

    function exitAndClear() {
      if(!confirm("ゲームから退出しますか？")) return;
      window.location.search = 't=' + Date.now();
    }

    function randomFill() {
      if(gameStarted) return; 
      const pool = [...candidates];
      for (let i = pool.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [pool[i], pool[j]] = [pool[j], pool[i]];
      }
      myCard = pool.slice(0, 9);
      renderGrid();
    }

    function openSelector(index) {
      if(gameStarted) return; 
      editingIndex = index;
      document.getElementById('selectorModal').style.display = 'flex';
      currentGenre = "BB1";
      renderTabs();
      renderList("BB1");
    }

    function closeModal(id) {
      document.getElementById(id).style.display = 'none';
    }

    function renderTabs() {
      const tabContainer = document.getElementById('genreTabs');
      tabContainer.innerHTML = "";
      const genres = ["BB1", "BB2", "BB3", "BSW", "BSB", "BSL", "BSWi", "BSBi", "FEEL", "L 24/25", "SP/OTHER"];
      genres.forEach(g => {
        const span = document.createElement('span');
        span.className = 'genre-tab';
        if(g === currentGenre) span.classList.add('active');
        span.textContent = g;
        span.onclick = function() {
          currentGenre = g; renderTabs(); renderList(g);
        };
        tabContainer.appendChild(span);
      });
    }

    function renderList(genre) {
      const listContainer = document.getElementById('programList');
      listContainer.innerHTML = "";
      listContainer.scrollTop = 0;
      
      const filtered = candidates.filter(prog => {
        if (genre === "SP/OTHER") return prog.includes("SP") || prog.startsWith("SKRILLEX") || prog === "BEERCYCLE";
        if (genre === "L 24/25") return prog.startsWith("L 24") || prog.startsWith("L 25");
        if (genre === "FEEL") return prog.startsWith("FEEL"); 
        return prog.startsWith(genre);
      });
      
      filtered.sort((a, b) => a.localeCompare(b, undefined, {numeric: true, sensitivity: 'base'}));

      filtered.forEach(prog => {
        const div = document.createElement('div');
        div.className = 'list-item';
        const nameSpan = document.createElement('span');
        nameSpan.textContent = prog;
        div.appendChild(nameSpan); 
        const badge = document.createElement('span');
        badge.className = 'selected-badge';
        badge.textContent = "選択済";
        div.appendChild(badge); 

        div.style.backgroundColor = getBgColor(prog); 
        div.style.color = getTextColor(prog);

        const isAlreadySelected = myCard.some((c, idx) => c === prog && idx !== editingIndex);
        if(isAlreadySelected) {
          div.classList.add('disabled');
        } else {
          div.onclick = function() {
            myCard[editingIndex] = prog;
            closeModal('selectorModal');
            renderGrid();
          };
        }
        listContainer.appendChild(div);
      });
    }

    function renderGrid() {
      const cells = document.getElementsByClassName('bingo-cell');
      let hits = new Array(9).fill(false);

      for(let i=0; i<9; i++) {
        const text = myCard[i];
        const cell = cells[i];
        cell.innerHTML = "";
        cell.removeAttribute("style"); 
        cell.className = "bingo-cell"; 

        if(text) {
          cell.textContent = text;
          cell.style.backgroundColor = getBgColor(text);
          cell.style.color = getTextColor(text);
          cell.style.borderRadius = "12px"; 

          if(drawnHistory.includes(text)) {
            hits[i] = true;
            cell.classList.add('hit');
            // opacity: 1 (透明度戻し)
          }
        } else {
          cell.innerHTML = "<span style='color:#999'>TAP</span>";
          cell.style.backgroundColor = "rgba(34,34,34,0.9)";
          cell.style.color = "white"; 
          cell.style.borderRadius = "12px"; 
        }
      }
      checkBingo(hits);
    }

    function checkBingo(hits) {
      if(isBingo) return;

      const lines = [[0,1,2], [3,4,5], [6,7,8], [0,3,6], [1,4,7], [2,5,8], [0,4,8], [2,4,6]];
      let currentBingo = false;
      for(let line of lines) {
        if(hits[line[0]] && hits[line[1]] && hits[line[2]]) currentBingo = true;
      }
      
      if(currentBingo) {
        isBingo = true;
        // 勝者は単純に名前と時間を送信
        db.ref('winners').push({ name: playerName, timestamp: Date.now() });
        document.getElementById('myBingoModal').style.display = 'flex';
        db.ref('gameState/history').off();
      }
    }

    function getBgColor(text) {
        if (text.startsWith("BB1")) return '#FFFF00';
        else if (text.startsWith("BB2")) return '#FF9933';
        else if (text.startsWith("BB3")) return '#FF3300';
        else if (text.startsWith("BSBi")) return '#336699';
        else if (text.startsWith("BSB")) return '#00CCFF';
        else if (text.startsWith("BSWi")) return '#990099';
        else if (text.startsWith("BSW")) return '#CC66FF';
        else if (text.startsWith("BSL")) return '#0000CC';
        else if (text.includes("FEEL NOW G")) return '#B08A3A';
        else if (text.includes("FEEL NOW S")) return '#666666';
        else if (text.includes("FEEL NOW B")) return '#00121C';
        else if (text.includes("FEEL HIGH")) return 'white';
        else if (text.includes("FEEL DEEP")) return 'white';
        else if (text.includes("BTM")) return '#00121C';
        else if (text.includes("FREE")) return '#00121C';
        else if (text.startsWith("FEEL NOW")) return '#00121C'; 
        else if (text.includes("FEEL")) return '#00121C';
        else if (text.includes("SP")) return '#00121C';
        else if (text === "BEERCYCLE") return '#7A3202';
        else if (text === "SKRILLEX") return 'white';
        return 'rgba(34, 34, 34, 0.9)'; 
    }

    function getTextColor(text) {
        // ★修正: BSBiは薄い黄色 #DEFF66
        if (text.startsWith("BSBi")) return '#DEFF66';

        if (text.startsWith("BB1") || text.startsWith("BB2") || text.startsWith("BB3") || 
            (text.startsWith("BSB") && !text.startsWith("BSBi")) || 
            text.startsWith("FEEL HIGH") || text.includes("FEEL DEEP") || text === "SKRILLEX") return 'black';
        else if (text.startsWith("BSWi")) return '#FFEF7F';
        else if (text.includes("BTM")) return '#BD3EA4';
        else if (text.includes("FREE")) return '#D61C1C';
        else if (text.startsWith("FEEL NOW")) return 'white';
        else if (text.includes("FEEL")) return '#0761F1';
        return 'white'; 
    }
  </script>
</body>
</html>
